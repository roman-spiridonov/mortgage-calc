Страница и скрипт для расчета более выгодного варианта: **Ипотека или Аренда квартиры**.

Первая версия скрипта вдохновлена статьей https://geektimes.ru/post/190170/, однако рассматривается более точная модель, чем та, что была описана в статье.  В частности, в исходной статье вызывают вопросы формулы для погашения кредита. Кроме того, оставлен без внимания вопрос возможного роста зарплаты (как минимум, индексации).

# Как читать результаты
Будем искать:
* Число месяцев для оплаты квартиры посредством кредита: $m$ 
* Число месяцев депозита:  $n$
* Стоимость квартиры сегодня: $S$

Исходя из следующих данных:
* Ставка по депозиту (% годовых): $F$ --> $f = 1+\frac{F/12}{100}$
* Ставка по кредиту (% годовых): $G$ --> $g = 1+\frac{G/12}{100}$
* Ставка роста цен на недвижимость (% годовых): $H$ --> $h = 1+\frac{H/12}{100}$
* Рост доходов (% годовых): $W$ --> $w = 1+\frac{W/12}{100}$
* Имеющиеся накопления: $A$
* Ежемесячные накопления за вычетом аренды: $B$ --> идет на депозитный вклад
* Стоимость аренды: $R$ --> на погашение кредита идет сумма $B+R$ 

Результат вычислений по заданным параметрам модели представляет собой два графика:

1. (основной) $f(n) = m(n)$ для произвольной $S$: график показывает, быстрее на квартиру накопить, сохраняя деньги на депозите, или выплачивая за нее кредит:
	- Быстрее накопить ($m>n$): график лежит выше кривой безразличия (<span style="color: blue">синей</span>)
	- Быстрее выплатить кредит ($m<n$): график лежит ниже кривой безразличия

	Число месяцев, на которое выгоднее тот или иной вариант, равно расстоянию по вертикали до _кривой безразличия_.

2. $S(n)$ - показывает стоимость квартиры *сегодня* (т. е. в ценах сегодняшнего дня), которую можно себе будет позволить при накоплении в течение $n$ лет (учтено, что эта квартира будет стоить больше через `n` лет). Очевидно, что график возрастает, если $F+W>H$ (накапливаем средства быстрее, чем растут цены).

# Описание решения
Рассмотрим два варианта задачи.

## Вариант 1: рост доходов не учитываем
Для **Депозита** равенство получаем, приравнивая стоимость квартиры через $n$ лет к сумме накоплений, состоящей из:
* $Af^n$: положили в банк уже имеющиеся накопления
* $Bf + Bf^2 + ... + Bf^n$: ежемесячные платежи в банк, равные размеру накоплений $B$, с учетом роста средств на депозите

Имеем:
$$Sh^n = Af^n + B(f + f^2 + \cdots + f^n)$$
Откуда:
$$S(n) = A(f/h)^n + \frac{Bf}{h^n}\frac{f^n - 1}{f - 1} \quad (1.1)$$

Вычислить $n$ из этого уравнения можно численно.

Для определения параметров **Кредита**, необходимо приравнять приведенную стоимость ежемесячных платежей к сумме займа, которая равна $S-A$. Иными словами, с точки зрения плательщика, кредит - это аннуитет. Ежемесячный платеж в этом случае __больше__ ежемесячных накоплений в случае депозита на сумму аренды, т.е. равен $\tilde{B} = B+R$.
Обозначив ежемесячную процентную ставку $G_m \equiv G/12$, сумма кредитных платежей представляет собой аннуитет 

\begin{align}
\tilde Ba_{\overline{m}|G_m} &= \tilde B\left[(1+G_m)^{-1}+(1+G_m)^{-2}+\cdots+(1+G_m)^{-m}\right] \\ 
&= \tilde B(1+G_m)^{-1}\left[\frac{(1+G_m)^{-m}-1}{(1+G_m)^{-1}-1}\right] \\ 
&= \frac{\tilde B}{G_m}\left[1 - (1+G_m)^{-m}\right]
\end{align}

Имеем: 
$$ S - A = \frac{\tilde{B}}{G_m}(1 - \frac{1}{(1+G_m)^m}) \quad (1.2)$$


Из уравнения (1.2) находим зависимость $m(n)$:
$$m(n) = \log_{\frac{1}{1+G_m}}\left(1 - \frac{G_m(S(n) - A)}{B+R}\right) \quad (1.3)$$
где $S(n)$ выражается из уравнения (1.1).



## Вариант 2: учитываем рост доходов
Введем коэффициент роста доходов $w = 1+\frac{W/100}{12}$.

Для **Депозита** стоимость квартиры через n лет должна равняться сумме накоплений, причем пополнения депозита имеют вид B, Bw, Bw^2, ..., Bw^{n-1}. Учитывая месячный коэффициент роста депозитов $f$, получаем:
$$ Sh^n = Af^n + Bf(f^{n-1} + f^{n-2}w + \cdots + w^{n-1}) $$

Отсюда:
$$\begin{align} S(n) &= A(f/h)^n + B(f/h^n)\left(f^{n-1} + f^{n-2}w + \cdots + fw^{n-2} + w^{n-1}\right) \\
&= A(f/h)^n + B\frac{fw^{n-1}}{h^n}\left((f/w)^{n-1} + \cdots + (f/w) + 1\right) \\
&= A(f/h)^n + B(f/h)(w/h)^{n-1}\frac{(f/w)^n-1}{(f/w)-1} \quad (2.1)
\end{align}$$

Вычислить $n$ из этого уравнения можно численно.

Для нахождения периода **Кредита**, сумма займа должна быть равна приведенной стоимости ежемесячных платежей по кредиту. Это утверждение верно всегда и получается из того факта, что $S(0) = S - A$ и $S(m) = 0$, где $S(t)$ - остаток долга на конец периода $t$. Поскольку доходы растут, мы будем вносить платежи с опережением графика (досрочное погашение кредита); ежемесячный платеж составит $C_j = \tilde{B}w^j$.
Имеем:
$$ S - A = \tilde{B}\left(\frac{1+W_m}{1+G_m} + \cdots + \left(\frac{1+W_m}{1+G_m}\right)^{m}\right)$$

Учитывая то, что $W_m\ll1$: $\frac{1+W_m}{1+G_m} \approx \frac{1}{1+(G_m-W_m)}$.

Таким образом, используя результат из вариант 1:

$$\begin{align} S - A &= \tilde{B}a_{\overline{m}|G_m-W_m} \\
 &=  \left\{
\begin{aligned} 
	\frac{\tilde{B}}{G_m-W_m}\left(1 - \frac{1}{(1 + G_m-W_m)^m}\right) \quad & G_m \neq W_m\\
	m\tilde{B}, \quad & G_m=W_m
\end{aligned}
\right. \quad (2.2)
\end{align}$$

Откуда находим зависимость $m(n)$, вспоминая, что $\tilde{B} = B+R$:
$$m(n) = \left\{
\begin{aligned} 
	\log_{\frac{1}{1+(G_m-W_m)}}\left[1 - \frac{G_m(S(n)-A)}{B+R} \right] \quad & G_m \neq W_m\\
	\frac{S-A}{B+R}, \quad & G_m=W_m
\end{aligned}
\right. \quad (2.3)$$
где $S(n)$ выражается из уравнения (1.1).


### Рост доходов = инфляции
Рассмотрим случай роста доходов с коэффициентом $w \equiv h$ . В этом случае выражение для $n$ можно вычислить аналитически (в общем случае, только численно).

Действительно, уравнение (2.1) в этом случае принимает вид:
$$\begin{align}
	Sh^n &= Af^n + B(f^n + f^{n-1}h + \cdots + fh^{n-1}) \\ 
	& = Af^n + Bf(f^{n-1} + f^{n-2}h + \cdots + fh^{n-2} + h^{n-1}) \quad  | \div h^n
\end{align}$$

Деля обе части на $h^n$, получаем:
$$S(n) = \left\{
\begin{aligned} 
	A(f/h)^n + B(f/h)\frac{(f/h)^n-1}{f/h-1}, \quad & f \neq h\\
	A+Bn, \quad & f=h
\end{aligned}
\right. \quad (2.1')$$

Отсюда находим $n$ аналитически:

$$n = \left\{
\begin{aligned} 
	\log_{f/h}\left[S + \frac{B(f/h)}{A + \frac{B(f/h)}{(f/h)-1}}\right] \quad & f \neq h\\
	\frac{S-A}{B}, \quad & f=h
\end{aligned}
\right. \quad (2.1'')
$$

Расчета формула для **Кредита** не изменятся.
